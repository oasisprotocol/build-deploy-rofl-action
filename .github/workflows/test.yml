name: test

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  # Unit tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

      - name: Run linter
        run: npm run lint

      - name: Run unit tests
        run: npm test

      - name: Build bundle
        run: npm run package

  # Check that dist/ is up-to-date
  check-dist:
    name: Check dist/ is up-to-date
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run bundle

      - name: Check for uncommitted changes
        run: |
          if [ -n "$(git status --porcelain dist/)" ]; then
            echo "::error::dist/ is out of date. Run 'npm run bundle' and commit the changes."
            git diff --stat dist/
            exit 1
          fi
          echo "dist/ is up-to-date"

  # E2E test: Basic offline build
  e2e-basic:
    name: E2E - Basic Offline Build
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and deploy to ROFL (offline)
        uses: ./
        with:
          wallet_account: test:grace
          network: testnet
          offline: true
          unsigned: true
          verify: true
          working_directory: .github/super-rofl-test

  # E2E test: Skip flags
  e2e-skip-flags:
    name: E2E - Skip Flags
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build only (skip update and deploy)
        uses: ./
        with:
          wallet_account: test:grace
          network: testnet
          offline: true
          unsigned: true
          skip_update: true
          skip_deploy: true
          working_directory: .github/super-rofl-test

  # E2E test: Output files
  e2e-output-files:
    name: E2E - Output Files
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build with output files
        id: rofl
        uses: ./
        with:
          wallet_account: test:grace
          network: testnet
          offline: true
          unsigned: true
          format: cbor
          update_output_file: update.cbor
          deploy_output_file: deploy.cbor
          working_directory: .github/super-rofl-test

      - name: Verify output files exist
        working-directory: .github/super-rofl-test
        run: |
          echo "Checking for output files..."
          if [ -f "update.cbor" ]; then
            echo "✓ update.cbor exists"
            ls -la update.cbor
          else
            echo "✗ update.cbor not found"
          fi
          if [ -f "deploy.cbor" ]; then
            echo "✓ deploy.cbor exists"
            ls -la deploy.cbor
          else
            echo "✗ deploy.cbor not found"
          fi

      - name: Check action outputs
        run: |
          echo "Update file output: ${{ steps.rofl.outputs.update_file }}"
          echo "Deploy file output: ${{ steps.rofl.outputs.deploy_file }}"

  # E2E test: Multiple platforms
  e2e-platforms:
    name: E2E - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: unit-tests
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test on ${{ matrix.os }}
        uses: ./
        with:
          wallet_account: test:grace
          network: testnet
          offline: true
          unsigned: true
          skip_update: true
          skip_deploy: true
          working_directory: .github/super-rofl-test
